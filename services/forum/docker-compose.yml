version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: discourse-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: discourse
      POSTGRES_USER: discourse
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-discourse_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - discourse-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U discourse"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: discourse-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - discourse-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  discourse:
    image: discourse/discourse:latest
    container_name: discourse-app
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Discourse Configuration
      DISCOURSE_HOSTNAME: ${DISCOURSE_HOSTNAME:-forum.dolesewonderlandfx.me}
      DISCOURSE_DEVELOPER_EMAILS: ${DISCOURSE_DEVELOPER_EMAILS:-admin@dolesewonderlandfx.me}
      
      # Database
      DISCOURSE_DB_HOST: postgres
      DISCOURSE_DB_NAME: discourse
      DISCOURSE_DB_USERNAME: discourse
      DISCOURSE_DB_PASSWORD: ${POSTGRES_PASSWORD:-discourse_password}
      
      # Redis
      DISCOURSE_REDIS_HOST: redis
      DISCOURSE_REDIS_PORT: 6379
      
      # SMTP Email Configuration (SendGrid)
      DISCOURSE_SMTP_ADDRESS: ${SMTP_ADDRESS:-smtp.sendgrid.net}
      DISCOURSE_SMTP_PORT: ${SMTP_PORT:-587}
      DISCOURSE_SMTP_USER_NAME: ${SMTP_USER:-apikey}
      DISCOURSE_SMTP_PASSWORD: ${SENDGRID_API_KEY}
      DISCOURSE_SMTP_ENABLE_START_TLS: 'true'
      DISCOURSE_SMTP_AUTHENTICATION: plain
      DISCOURSE_SMTP_DOMAIN: ${SMTP_DOMAIN:-dolesewonderlandfx.me}
      
      # Site Settings
      DISCOURSE_CDN_URL: ${DISCOURSE_CDN_URL:-}
      DISCOURSE_ENABLE_CORS: 'true'
      DISCOURSE_CORS_ORIGIN: ${CORS_ORIGIN:-https://dolesewonderlandfx.me,https://app.dolesewonderlandfx.me}
      
      # Security
      DISCOURSE_FORCE_HTTPS: 'true'
      DISCOURSE_USE_S3: ${USE_S3:-false}
      
      # AWS S3 (Optional - for file uploads)
      DISCOURSE_S3_REGION: ${AWS_REGION:-us-east-1}
      DISCOURSE_S3_BUCKET: ${S3_BUCKET:-dolesewonderlandfx-forum}
      DISCOURSE_S3_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      DISCOURSE_S3_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      
      # SSO Integration (Optional - for single sign-on with main app)
      DISCOURSE_SSO_URL: ${SSO_URL:-https://app.dolesewonderlandfx.me/auth/sso}
      DISCOURSE_SSO_SECRET: ${SSO_SECRET}
      DISCOURSE_ENABLE_SSO: ${ENABLE_SSO:-false}
      
      # Performance
      UNICORN_WORKERS: ${UNICORN_WORKERS:-2}
      
    volumes:
      - discourse_data:/shared
    ports:
      - "8080:80"
      - "8443:443"
    networks:
      - discourse-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  discourse_data:
    driver: local

networks:
  discourse-network:
    driver: bridge
